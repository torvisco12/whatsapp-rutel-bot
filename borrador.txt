const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

// InicializaciÃ³n del cliente de WhatsApp
const client = new Client({
    authStrategy: new LocalAuth(),  // Persistir la sesiÃ³n utilizando LocalAuth
});

// GeneraciÃ³n y visualizaciÃ³n del cÃ³digo QR para autenticaciÃ³n
client.on('qr', (qr) => {
    qrcode.generate(qr, { small: true });
    io.emit('qr', qr);  // Enviar el QR al frontend
});

// Evento cuando el cliente de WhatsApp estÃ¡ listo
client.on('ready', () => {
    console.log('Â¡Estoy listo para ayudarte! ğŸ˜Š');
    io.emit('ready');  // Notificar al frontend que el bot estÃ¡ listo

    // Enviar un mensaje de bienvenida al usuario
    io.emit('message', "Â¡Hola! ğŸ‘‹ Soy el asistente de Rutel Comunicaciones. Â¿CÃ³mo puedo ayudarte hoy? ğŸ˜Š\nEscrÃ­beme el nÃºmero de la opciÃ³n que mÃ¡s te interese:\n\n1ï¸âƒ£ Ver nuestros productos\n2ï¸âƒ£ Descubrir nuestros servicios\n3ï¸âƒ£ Necesito soporte tÃ©cnico\n4ï¸âƒ£ Salir del chat");
});

// Manejo de mensajes entrantes
client.on('message', (message) => {
    console.log('Nuevo mensaje recibido:', message.body);

    // Enviar el mensaje recibido al frontend
    io.emit('message', message.body);

    // LÃ³gica para responder con opciones predefinidas
    let respuesta = getResponse(message.body);

    // Enviar la respuesta a WhatsApp
    client.sendMessage(message.from, respuesta)
        .then(response => {
            io.emit('message', respuesta);  // Enviar la misma respuesta al frontend
        })
        .catch(error => {
            console.error('Error enviando mensaje a WhatsApp:', error);
            io.emit('message', 'Hubo un error al enviar el mensaje. Intenta de nuevo. ğŸ˜•');
        });
});

// FunciÃ³n para obtener la respuesta basada en el mensaje del usuario
function getResponse(messageBody) {
    let respuesta = '';

    // Manejo de opciones del menÃº principal y subopciones en un solo switch
    switch (true) {
        // MenÃº Principal
        case /hola|holaa|respondan|responder|Que tal|quetal|Como Estan|como estan|quiero saber|me interesan los productos|me puedes contar sobre|necesito saber|quiero conocer|quiero mÃ¡s informaciÃ³n|que opciones tengo|como puedo adquirir|donde puedo comprar|informaciÃ³n sobre|productos|servicios|ofrecen|que servicios tienen|que productos venden|me puedes mostrar los productos|que planes tienen|que opciones de internet tienen|necesito soporte|necesito ayuda|tengo un problema|necesito ayuda con|problema de internet|tengo un inconveniente|necesito soporte tÃ©cnico|necesito asesoramiento|como contratar|como puedo contratar|me interesa el plan|me interesa un plan|tienen planes de internet|que servicios ofrecen|me puedes dar detalles sobre/i.test(messageBody):
            respuesta = "Â¡Hola! ğŸ‘‹ Soy el asistente de Rutel Comunicaciones. Â¿CÃ³mo puedo ayudarte hoy? ğŸ˜Š\nEscrÃ­beme el nÃºmero de la opciÃ³n que mÃ¡s te interese:\n\n1ï¸âƒ£ Ver nuestros productos\n2ï¸âƒ£ Descubrir nuestros servicios\n3ï¸âƒ£ Necesito soporte tÃ©cnico\n4ï¸âƒ£ Salir del chat";
            break;

        // OpciÃ³n 1 (Productos)
        case messageBody === '1':
            respuesta = "Â¡Excelente elecciÃ³n! AquÃ­ estÃ¡n algunos de nuestros productos disponibles, diseÃ±ados para mejorar tu experiencia:\n\n" +
                    "1ï¸âƒ£ **Plan BÃ¡sico (10 Mbps)**: Ideal para navegar y hacer videollamadas.\n" +
                    "2ï¸âƒ£ **Plan Avanzado (50 Mbps)**: Perfecto para familias y oficinas.\n" +
                    "3ï¸âƒ£ **Router Wi-Fi**: Para tener conexiÃ³n estable en toda tu casa.\n" +
                    "4ï¸âƒ£ **MÃ³dem portÃ¡til**: LlÃ©vate el internet donde vayas.\n\n" +
                    "Elige el nÃºmero del producto que te interesa o escribe '0' para regresar al menÃº principal.\n\n" +
                    "Por ejemplo: escribe '1.1' para saber mÃ¡s sobre el **Plan BÃ¡sico (10 Mbps)** o '1.2' para el **Plan Avanzado (50 Mbps)**.";
            break;

        // OpciÃ³n 2 (Servicios)
        case messageBody === '2':
            respuesta = "Nuestros servicios estÃ¡n pensados para mejorar tu dÃ­a a dÃ­a. AquÃ­ tienes las opciones:\n\n" +
                       "1ï¸âƒ£ **Planes de Internet**: Internet rÃ¡pido y confiable para tu hogar o negocio.\n" +
                       "2ï¸âƒ£ **InstalaciÃ³n de cÃ¡maras de seguridad**: Protege tu hogar o negocio con tecnologÃ­a de Ãºltima generaciÃ³n.\n\n" +
                       "Elige el nÃºmero del servicio que te interesa o escribe '0' para regresar al menÃº principal.";
            break;

        // OpciÃ³n 3 (Soporte)
        case messageBody === '3':
            respuesta = "Â¡Estoy aquÃ­ para ayudarte con cualquier problema tÃ©cnico! ğŸ˜Š Elige el nÃºmero que mÃ¡s se ajusta a tu problema:\n\n" +
                       "1ï¸âƒ£ **Problema de conexiÃ³n a Internet**\n" +
                       "2ï¸âƒ£ **Problema con dispositivos**\n" +
                       "3ï¸âƒ£ **Otro problema tÃ©cnico**\n\n" +
                       "Elige el nÃºmero del problema que tienes o escribe '0' para regresar al menÃº principal.";
            break;

        // OpciÃ³n 4 (Salir)
        case messageBody === '4':
            respuesta = "Gracias por confiar en Rutel Comunicaciones. Â¡Nos vemos pronto! ğŸ˜Š Si en algÃºn momento necesitas algo, estarÃ© aquÃ­ para ayudarte.";
            break;

        // Subopciones (1.1, 1.2, 2.1, etc.)
        case messageBody === '1.1':
            respuesta = "Â¡Genial! EstÃ¡s interesado en el **Plan BÃ¡sico (10 Mbps)**: Ideal para navegar y hacer videollamadas.\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '1.2':
            respuesta = "Â¡Perfecto! EstÃ¡s interesado en el **Plan Avanzado (50 Mbps)**: Perfecto para familias y oficinas.\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '2.1':
            respuesta = "Â¡Perfecto! EstÃ¡s interesado en nuestros **Planes de Internet**. Ofrecemos opciones para todo tipo de usuarios. Â¿Te gustarÃ­a mÃ¡s informaciÃ³n sobre algÃºn plan en particular?\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '2.2':
            respuesta = "Â¡EstÃ¡s interesado en **InstalaciÃ³n de cÃ¡maras de seguridad**! Protege tu hogar o negocio con tecnologÃ­a de Ãºltima generaciÃ³n.\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '3.1':
            respuesta = "Entiendo que tienes un problema con **la conexiÃ³n a Internet**. Â¿PodrÃ­as describir el problema en detalle? Estoy aquÃ­ para ayudarte.\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '3.2':
            respuesta = "Entiendo que tienes un problema con **los dispositivos**. Â¿PodrÃ­as decirme quÃ© dispositivo estÃ¡ causando el problema? Estoy aquÃ­ para ayudarte.\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;
        case messageBody === '3.3':
            respuesta = "Entiendo que tienes otro **problema tÃ©cnico**. Â¿PodrÃ­as describir el problema en detalle para que te pueda asistir mejor?\n\nEscrÃ­beme '0' para regresar al menÃº o 'salir' para finalizar la conversaciÃ³n.";
            break;

        // Si el usuario escribe 0 para regresar al menÃº
        case messageBody === '0':
            respuesta = "Â¿En quÃ© puedo ayudarte hoy? ğŸ˜Š Escribe el nÃºmero de la opciÃ³n que mÃ¡s te interese:\n\n1ï¸âƒ£ Ver nuestros productos\n2ï¸âƒ£ Descubrir nuestros servicios\n3ï¸âƒ£ Necesito soporte tÃ©cnico\n4ï¸âƒ£ Salir del chat";
            break;

        // Si no se entiende el mensaje
        default:
            respuesta = "Lo siento, no entendÃ­ tu mensaje en esta secciÃ³n. ğŸ˜• Por favor, responde con el nÃºmero de la opciÃ³n que deseas (1-4), o usa subopciones como 1.1, 1.2, etc. Si no estÃ¡s seguro, escribe '0' para regresar al menÃº principal.";
            break;
    }

    return respuesta;
}

// Evento cuando el cliente de WhatsApp se desconecta
client.on('disconnected', (reason) => {
    console.log('Cliente desconectado:', reason);
    io.emit('disconnected', 'El cliente de WhatsApp se ha desconectado. Intenta reconectar mÃ¡s tarde.');
});

// Inicializar el cliente de WhatsApp
client.initialize();

// ConfiguraciÃ³n del puerto del servidor
server.listen(3000, () => {
    console.log('Servidor corriendo en el puerto 3000. Â¡Listo para ayudarte! ğŸ˜Š');
});
